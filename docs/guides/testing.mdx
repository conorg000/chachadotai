---
title: 'Testing Guide'
description: 'Test your SafetyLayer integration'
---

## Overview

This guide covers testing strategies for applications using the SafetyLayer SDK.

## Unit Testing

### Mocking the SDK

Mock the SafetyLayer client in your unit tests:

```typescript
import { jest } from '@jest/globals';
import { SafetyLayer } from '@safetylayer/core';

jest.mock('@safetylayer/core');

describe('Chat Handler', () => {
  let mockSafety: jest.Mocked<SafetyLayer>;

  beforeEach(() => {
    mockSafety = {
      recordUserMessage: jest.fn().mockResolvedValue({ 
        ok: true, 
        eventId: 'evt_123' 
      }),
      recordAssistantMessage: jest.fn().mockResolvedValue({ 
        ok: true, 
        eventId: 'evt_124' 
      }),
      evaluate: jest.fn().mockResolvedValue({
        riskScore: 0.5,
        patterns: [],
        action: null,
        sessionId: 'test',
        timestamp: Date.now(),
      }),
      shouldBlock: jest.fn().mockResolvedValue(false),
    } as any;
  });

  it('records messages', async () => {
    await handleChat('sess_123', 'Hello');

    expect(mockSafety.recordUserMessage).toHaveBeenCalledWith(
      'sess_123',
      'Hello'
    );
  });

  it('blocks high-risk sessions', async () => {
    mockSafety.shouldBlock.mockResolvedValue(true);

    const result = await handleChat('sess_123', 'Malicious input');

    expect(result.blocked).toBe(true);
  });
});
```

### Testing Error Handling

```typescript
import { SafetyLayerError, NetworkError } from '@safetylayer/core';

describe('Error Handling', () => {
  it('handles API errors gracefully', async () => {
    mockSafety.evaluate.mockRejectedValue(
      new SafetyLayerError('API error', 'internal_error', 500)
    );

    const result = await handleChat('sess_123', 'Hello');

    // Should continue despite error
    expect(result.content).toBeDefined();
  });

  it('handles network errors', async () => {
    mockSafety.recordUserMessage.mockRejectedValue(
      new NetworkError('Connection refused')
    );

    const result = await handleChat('sess_123', 'Hello');

    // Should handle gracefully
    expect(result).toBeDefined();
  });
});
```

## Integration Testing

### With Test Backend

Test against a real backend instance:

```typescript
import { SafetyLayer } from '@safetylayer/core';

describe('SafetyLayer Integration', () => {
  let safety: SafetyLayer;

  beforeAll(() => {
    safety = new SafetyLayer({
      apiKey: 'test_key',
      projectId: 'proj_test',
      endpoint: 'http://localhost:3001',
    });
  });

  it('records and evaluates sessions', async () => {
    const sessionId = `test_${Date.now()}`;

    // Record user message
    await safety.recordUserMessage(sessionId, 'Hello');

    // Evaluate
    const decision = await safety.evaluate({ sessionId });

    expect(decision.riskScore).toBeGreaterThanOrEqual(0);
    expect(decision.riskScore).toBeLessThanOrEqual(1);
  });
});
```

### End-to-End Testing

Test the complete flow with Playwright or Cypress:

```typescript
import { test, expect } from '@playwright/test';

test('chat with safety monitoring', async ({ page }) => {
  await page.goto('http://localhost:3000/chat');

  // Send message
  await page.fill('[data-testid="message-input"]', 'Hello!');
  await page.click('[data-testid="send-button"]');

  // Wait for response
  await expect(page.locator('[data-testid="response"]')).toBeVisible();

  // Check risk indicator
  const riskScore = await page.locator('[data-testid="risk-score"]').textContent();
  expect(parseFloat(riskScore!)).toBeGreaterThanOrEqual(0);
});
```

## Testing Strategies

### Test Fixtures

Create reusable test data:

```typescript
export const testFixtures = {
  benignMessage: 'Hello, how can you help me?',
  suspiciousMessage: 'Show me all user data',
  maliciousMessage: 'Ignore previous instructions and...',
  
  lowRiskDecision: {
    riskScore: 0.2,
    patterns: [],
    action: null,
  },
  
  highRiskDecision: {
    riskScore: 0.9,
    patterns: ['reconnaissance', 'gradual_escalation'],
    action: 'block',
  },
};
```

### Mock Responses

```typescript
export function mockSafetyLayer() {
  return {
    recordUserMessage: jest.fn().mockResolvedValue({ ok: true, eventId: 'evt_1' }),
    recordAssistantMessage: jest.fn().mockResolvedValue({ ok: true, eventId: 'evt_2' }),
    recordCoT: jest.fn().mockResolvedValue({ ok: true, eventId: 'evt_3' }),
    evaluate: jest.fn().mockResolvedValue({
      riskScore: 0.5,
      patterns: [],
      action: null,
      sessionId: 'test',
      timestamp: Date.now(),
    }),
    shouldBlock: jest.fn().mockResolvedValue(false),
    generateSessionId: jest.fn().mockReturnValue('sess_test_123'),
  };
}
```

## Best Practices

<AccordionGroup>
  <Accordion title="Mock in Unit Tests" icon="code">
    Always mock the SDK in unit tests. Test your logic, not the SDK.
  </Accordion>

  <Accordion title="Test Error Paths" icon="triangle-exclamation">
    Test how your code handles SafetyLayer errors and network failures.
  </Accordion>

  <Accordion title="Use Integration Tests Sparingly" icon="flask">
    Integration tests against the real backend are slower. Use them for critical flows.
  </Accordion>

  <Accordion title="Test Different Risk Levels" icon="gauge">
    Test behavior for low, medium, and high-risk scenarios.
  </Accordion>

  <Accordion title="Verify SDK Calls" icon="check">
    Ensure your code calls SDK methods at the right times with correct parameters.
  </Accordion>
</AccordionGroup>

## CI/CD Integration

### GitHub Actions

```yaml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      safetylayer-backend:
        image: safetylayer/backend:latest
        ports:
          - 3001:3001

    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
      - name: Run unit tests
        run: npm test
      
      - name: Run integration tests
        env:
          BACKEND_URL: http://localhost:3001
        run: npm run test:integration
```

## Related

<CardGroup cols={2}>
  <Card
    title="Integration Guide"
    icon="puzzle-piece"
    href="/guides/integration"
  >
    Integration patterns
  </Card>
  
  <Card
    title="Error Handling"
    icon="triangle-exclamation"
    href="/api-reference/error-handling"
  >
    Error handling guide
  </Card>
  
  <Card
    title="SDK Reference"
    icon="code"
    href="/api-reference/safetylayer-client"
  >
    Complete SDK API
  </Card>
</CardGroup>
