---
title: 'API Endpoints Reference'
description: 'Complete reference for the SafetyLayer demo API'
---

## Base URL

```
http://localhost:3001
```

<Info>
  Change the port in `.env` if needed: `PORT=3001`
</Info>

---

## Endpoints

### GET /health

Health check endpoint to verify the API is running.

**Request:**
```bash
curl http://localhost:3001/health
```

**Response:**
```json
{
  "status": "ok",
  "timestamp": 1699999999999
}
```

<ResponseField name="status" type="string">
  Always "ok" if API is responding
</ResponseField>

<ResponseField name="timestamp" type="number">
  Current server timestamp (Unix milliseconds)
</ResponseField>

---

### POST /chat

Send a message and receive an AI response with safety analysis.

**Request:**

<ParamField path="sessionId" type="string" required>
  Unique identifier for this conversation session
</ParamField>

<ParamField path="userMessage" type="string" required>
  The user's message text
</ParamField>

<CodeGroup>

```bash cURL
curl -X POST http://localhost:3001/chat \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "user-123",
    "userMessage": "Hello! How are you?"
  }'
```

```javascript JavaScript
const response = await fetch('http://localhost:3001/chat', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    sessionId: 'user-123',
    userMessage: 'Hello! How are you?'
  })
});

const data = await response.json();
```

```python Python
import requests

response = requests.post('http://localhost:3001/chat', json={
    'sessionId': 'user-123',
    'userMessage': 'Hello! How are you?'
})

data = response.json()
```

</CodeGroup>

**Success Response (200):**

```json
{
  "assistant": {
    "id": "msg-1699999999999-assistant",
    "sessionId": "user-123",
    "role": "assistant",
    "content": "I'm doing well, thank you! How can I help you today?",
    "timestamp": 1699999999999,
    "cotRecord": {
      "messageId": "msg-1699999999999-assistant",
      "sessionId": "user-123",
      "rawCoT": "User greeting me. I should respond warmly...",
      "userInput": "Hello! How are you?",
      "finalOutput": "I'm doing well, thank you! How can I help you today?",
      "analysis": {
        "riskScore": 0.0,
        "labels": [],
        "indicators": [],
        "summary": "Clean greeting response with no safety concerns."
      }
    }
  },
  "session": {
    "riskScore": 0.05,
    "patterns": [],
    "messageCount": 2
  },
  "cot": {
    "riskScore": 0.0,
    "labels": [],
    "indicators": [],
    "summary": "Clean greeting response with no safety concerns."
  }
}
```

<ResponseField name="assistant" type="Message">
  The AI's response message with CoT analysis
  
  <Expandable title="fields">
    <ResponseField name="id" type="string">Message ID</ResponseField>
    <ResponseField name="sessionId" type="string">Session ID</ResponseField>
    <ResponseField name="role" type="string">Always "assistant"</ResponseField>
    <ResponseField name="content" type="string">Response text</ResponseField>
    <ResponseField name="timestamp" type="number">Unix milliseconds</ResponseField>
    <ResponseField name="cotRecord" type="CoTRecord">Chain-of-thought analysis</ResponseField>
  </Expandable>
</ResponseField>

<ResponseField name="session" type="object">
  Current session state summary
  
  <Expandable title="fields">
    <ResponseField name="riskScore" type="number">Behavioral risk (0-1)</ResponseField>
    <ResponseField name="patterns" type="string[]">Detected patterns</ResponseField>
    <ResponseField name="messageCount" type="number">Total messages in session</ResponseField>
  </Expandable>
</ResponseField>

<ResponseField name="cot" type="CoTAnalysis | null">
  Chain-of-thought analysis (null if no reasoning available)
</ResponseField>

**Error Responses:**

<CodeGroup>

```json 400 Bad Request
{
  "error": "sessionId and userMessage required"
}
```

```json 403 Forbidden (Session Blocked)
{
  "error": "Session blocked",
  "reason": "This session has been blocked due to safety concerns."
}
```

```json 403 Forbidden (Message Blocked)
{
  "error": "Request blocked",
  "reason": "Your message triggered safety concerns."
}
```

```json 500 Internal Server Error
{
  "error": "Internal server error",
  "message": "OpenAI API error: ..."
}
```

</CodeGroup>

---

### GET /sessions

List all active sessions.

**Request:**
```bash
curl http://localhost:3001/sessions
```

**Response:**
```json
{
  "sessions": [
    {
      "sessionId": "user-123",
      "messages": [
        {
          "id": "msg-1",
          "sessionId": "user-123",
          "role": "user",
          "content": "Hello!",
          "timestamp": 1699999999999
        },
        {
          "id": "msg-2",
          "sessionId": "user-123",
          "role": "assistant",
          "content": "Hi there!",
          "timestamp": 1699999999999,
          "cotRecord": { ... }
        }
      ],
      "riskScore": 0.05,
      "patterns": [],
      "timeline": [
        {
          "atMessageId": "msg-1",
          "riskScore": 0.05,
          "patterns": []
        },
        {
          "atMessageId": "msg-2",
          "riskScore": 0.05,
          "patterns": []
        }
      ]
    },
    {
      "sessionId": "user-456",
      "messages": [ ... ],
      "riskScore": 0.75,
      "patterns": ["gradual_escalation"],
      "timeline": [ ... ]
    }
  ]
}
```

<ResponseField name="sessions" type="SessionState[]">
  Array of all session states
</ResponseField>

**Use Cases:**
- Dashboard: Display all active conversations
- Monitoring: Find high-risk sessions
- Analytics: Analyze conversation patterns

---

### GET /sessions/:id

Get details for a specific session.

**Request:**

<ParamField path="id" type="string" required>
  The session ID to retrieve
</ParamField>

```bash
curl http://localhost:3001/sessions/user-123
```

**Success Response (200):**
```json
{
  "session": {
    "sessionId": "user-123",
    "messages": [
      {
        "id": "msg-1",
        "sessionId": "user-123",
        "role": "user",
        "content": "How does authentication work?",
        "timestamp": 1699999999999
      },
      {
        "id": "msg-2",
        "sessionId": "user-123",
        "role": "assistant",
        "content": "Authentication verifies identity...",
        "timestamp": 1699999999999,
        "cotRecord": {
          "analysis": {
            "riskScore": 0.0,
            "labels": [],
            "summary": "Clean educational response"
          }
        }
      }
    ],
    "riskScore": 0.15,
    "patterns": [],
    "timeline": [
      { "atMessageId": "msg-1", "riskScore": 0.1, "patterns": [] },
      { "atMessageId": "msg-2", "riskScore": 0.15, "patterns": [] }
    ]
  }
}
```

**Error Response (404):**
```json
{
  "error": "Session not found"
}
```

**Use Cases:**
- View conversation history
- Analyze risk progression
- Review CoT analysis for all messages

---

## Frontend Integration Examples

### Vanilla JavaScript

```html
<!DOCTYPE html>
<html>
<head>
  <title>SafetyLayer Chat</title>
</head>
<body>
  <div id="chat">
    <div id="messages"></div>
    <input id="input" type="text" placeholder="Type a message..." />
    <button id="send">Send</button>
  </div>

  <script>
    const API_URL = 'http://localhost:3001';
    const sessionId = `session-${Date.now()}`;
    
    document.getElementById('send').addEventListener('click', async () => {
      const input = document.getElementById('input');
      const message = input.value.trim();
      if (!message) return;

      input.value = '';
      addMessage('user', message);

      try {
        const response = await fetch(`${API_URL}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId, userMessage: message })
        });

        const data = await response.json();

        if (response.ok) {
          addMessage('assistant', data.assistant.content);
          updateRisk(data.session.riskScore, data.session.patterns);
        } else {
          alert(`Error: ${data.error}`);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to send message');
      }
    });

    function addMessage(role, content) {
      const messages = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = `message ${role}`;
      div.textContent = content;
      messages.appendChild(div);
    }

    function updateRisk(score, patterns) {
      console.log(`Risk: ${score}, Patterns: ${patterns.join(', ')}`);
    }
  </script>
</body>
</html>
```

### React

```typescript
import { useState } from 'react';

const API_URL = 'http://localhost:3001';

interface Message {
  role: 'user' | 'assistant';
  content: string;
}

export function Chat() {
  const [sessionId] = useState(`session-${Date.now()}`);
  const [messages, setMessages] = useState<Message[]>([]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  const [risk, setRisk] = useState(0);

  async function sendMessage() {
    if (!input.trim() || loading) return;

    const userMessage = input;
    setInput('');
    setMessages(prev => [...prev, { role: 'user', content: userMessage }]);
    setLoading(true);

    try {
      const response = await fetch(`${API_URL}/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sessionId, userMessage })
      });

      const data = await response.json();

      if (response.ok) {
        setMessages(prev => [...prev, { 
          role: 'assistant', 
          content: data.assistant.content 
        }]);
        setRisk(data.session.riskScore);
      } else {
        alert(`Error: ${data.error}`);
      }
    } catch (error) {
      console.error('Error:', error);
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="chat">
      <div className="risk-indicator">Risk: {risk.toFixed(2)}</div>
      <div className="messages">
        {messages.map((msg, i) => (
          <div key={i} className={`message ${msg.role}`}>
            {msg.content}
          </div>
        ))}
      </div>
      <div className="input-area">
        <input
          value={input}
          onChange={(e) => setInput(e.target.value)}
          onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
          placeholder="Type a message..."
          disabled={loading}
        />
        <button onClick={sendMessage} disabled={loading}>
          {loading ? 'Sending...' : 'Send'}
        </button>
      </div>
    </div>
  );
}
```

### Vue.js

```vue
<template>
  <div class="chat">
    <div class="risk-indicator">Risk: {{ risk.toFixed(2) }}</div>
    <div class="messages">
      <div v-for="(msg, i) in messages" :key="i" :class="`message ${msg.role}`">
        {{ msg.content }}
      </div>
    </div>
    <div class="input-area">
      <input
        v-model="input"
        @keyup.enter="sendMessage"
        placeholder="Type a message..."
        :disabled="loading"
      />
      <button @click="sendMessage" :disabled="loading">
        {{ loading ? 'Sending...' : 'Send' }}
      </button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue';

const API_URL = 'http://localhost:3001';
const sessionId = ref(`session-${Date.now()}`);
const messages = ref<Array<{ role: string; content: string }>>([]);
const input = ref('');
const loading = ref(false);
const risk = ref(0);

async function sendMessage() {
  if (!input.value.trim() || loading.value) return;

  const userMessage = input.value;
  input.value = '';
  messages.value.push({ role: 'user', content: userMessage });
  loading.value = true;

  try {
    const response = await fetch(`${API_URL}/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        sessionId: sessionId.value,
        userMessage
      })
    });

    const data = await response.json();

    if (response.ok) {
      messages.value.push({
        role: 'assistant',
        content: data.assistant.content
      });
      risk.value = data.session.riskScore;
    } else {
      alert(`Error: ${data.error}`);
    }
  } catch (error) {
    console.error('Error:', error);
  } finally {
    loading.value = false;
  }
}
</script>
```

---

## Common Patterns

### Checking Session Risk Before Proceeding

```typescript
async function isSessionSafe(sessionId: string): Promise<boolean> {
  const response = await fetch(`http://localhost:3001/sessions/${sessionId}`);
  const data = await response.json();
  
  if (response.status === 404) {
    return true; // New session, allow
  }
  
  return data.session.riskScore < 0.9;
}

// Usage
if (await isSessionSafe('user-123')) {
  // Allow message
} else {
  // Block or warn user
}
```

### Finding High-Risk Sessions

```typescript
async function getHighRiskSessions(threshold: number = 0.7) {
  const response = await fetch('http://localhost:3001/sessions');
  const data = await response.json();
  
  return data.sessions.filter(s => s.riskScore > threshold);
}

// Usage
const riskySessions = await getHighRiskSessions(0.7);
console.log(`Found ${riskySessions.length} high-risk sessions`);
```

### Monitoring Risk Trends

```typescript
function getRiskTrend(timeline: RiskSnapshot[]): 'increasing' | 'decreasing' | 'stable' {
  if (timeline.length < 2) return 'stable';
  
  const recent = timeline.slice(-5);
  const first = recent[0].riskScore;
  const last = recent[recent.length - 1].riskScore;
  
  if (last > first + 0.2) return 'increasing';
  if (last < first - 0.2) return 'decreasing';
  return 'stable';
}

// Usage
const response = await fetch('http://localhost:3001/sessions/user-123');
const { session } = await response.json();
const trend = getRiskTrend(session.timeline);

if (trend === 'increasing') {
  console.warn('⚠️ Risk is trending upward');
}
```

---

## Rate Limiting

The demo API does not include rate limiting by default. For production, add:

```typescript
import rateLimit from 'express-rate-limit';

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100, // limit each IP to 100 requests per windowMs
  message: 'Too many requests, please try again later.'
});

app.use('/chat', limiter);
```

---

## CORS Configuration

CORS is enabled by default for all origins in the demo:

```typescript
import cors from 'cors';

app.use(cors()); // Allow all origins
```

For production, restrict origins:

```typescript
app.use(cors({
  origin: ['https://yourdomain.com', 'https://www.yourdomain.com']
}));
```

---

## See Also

<CardGroup cols={3}>
  <Card title="Running the Demo" href="/demo/running-demo" icon="play">
    Setup instructions
  </Card>
  <Card title="Dashboard" href="/demo/dashboard" icon="chart-line">
    Frontend visualization
  </Card>
  <Card title="API Reference" href="/api-reference/session-engine" icon="book">
    Core library docs
  </Card>
</CardGroup>

